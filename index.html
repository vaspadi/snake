<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width">
	<title>Snake 2</title>
</head>

<body>
	<div class="game">
		<canvas id="canvas" width="700" height="700"></canvas>
		<button id="test-button">Click!</button>
	</div>

	<script>
		const canvas = document.getElementById('canvas');
		const button = document.getElementById('test-button');
		const ctx = canvas.getContext('2d');
		const width = canvas.width;
		const height = canvas.height;
		const blockNum = 20;
		const blockWidth = width / blockNum;
		const blockHeight = height / blockNum;
		const directions = {
			37: 'left',
			38: 'up',
			39: 'right',
			40: 'down'
		}
		let score = 0;
		let nextRecord = 10;
		let speed = 300;
		let stop = false;


		function drawField() {
			ctx.fillStyle = '#eee600';
			ctx.fillRect(0, 0, width, height)

			ctx.fillStyle = '#000';
			ctx.fillRect(0, 0, width, blockHeight); // up
			ctx.fillRect(width - blockWidth, 0, blockWidth, height); // right
			ctx.fillRect(0, 0, blockWidth, height); // left
			ctx.fillRect(0, height - blockHeight, width, blockHeight); // down
		}

		function drawScore() {
			ctx.font = '30px Fantasy';
			ctx.strokeStyle = '#000';
			ctx.lineWidth = 2;
			ctx.strokeText('Score: ' + score, blockWidth * 1.25, blockHeight * 2);
			ctx.fillStyle = 'red';
			ctx.fillText('Score: ' + score, blockWidth * 1.25, blockHeight * 2);
		}

		function setSpeed() {
			if (score === nextRecord && speed > 100) {
				speed -= 50;
				nextRecord += 10;
			}
			return speed;
		}

		let Block = function(col, row) {
			this.col = col;
			this.row = row;
		}

		Block.prototype.drawSquare = function(color, border) {
			let x = this.col * blockWidth;
			let y = this.row * blockHeight;
			let lineWidth = 0;
			let sizeError = 0;

			if (!!border) {
				lineWidth = blockWidth / 3.5;
				sizeError = lineWidth / 2;
				ctx.strokeStyle = border;
			}
			
			ctx.fillStyle = color;
			ctx.lineWidth = lineWidth;
			ctx.fillRect(x + sizeError , y + sizeError, blockWidth - lineWidth, blockHeight - lineWidth);

			if (!!border) {
				ctx.strokeRect(x + sizeError, y + sizeError, blockWidth - lineWidth, blockHeight - lineWidth);
			}
		}

		Block.prototype.drawCircle = function(color, border) {
			let centerX = this.col * blockWidth + blockWidth / 2;
			let centerY = this.row * blockHeight + blockHeight / 2;
			let lineWidth = 0;
			let sizeError = 0;

			if (!!border) {
				lineWidth = blockWidth / 6;
				sizeError = lineWidth / 2;
				ctx.strokeStyle = border;
			}

			ctx.fillStyle = color;
			ctx.lineWidth = lineWidth;
			ctx.beginPath();
			ctx.arc(centerX, centerY, blockWidth / 2 - sizeError, 0, Math.PI * 2, false);
			ctx.fill();

			if (!!border) {
				ctx.stroke();
			}
		}

		Block.prototype.equal = function(otherBlock) {
			return this.col === otherBlock.col && this.row === otherBlock.row;
		}

		let Snake = function() {
			this.segments = [
				new Block(3, 1),
				new Block(2, 1),
				new Block(1, 1)
			];
			this.direction = 'right';
			this.nextDirection = 'right';
		}

		Snake.prototype.draw = function() {
			for (let i = 0; i < this.segments.length; i++) {
				this.segments[i].drawSquare('#17a017', '#1f461f');
			}
		}

		Snake.prototype.move = function() {
			let head = this.segments[0];
			let newHead;
			this.direction = this.nextDirection;

			if (this.direction === 'right') {
				newHead = new Block(head.col + 1, head.row);
			} else if (this.direction === 'down') {
				newHead = new Block(head.col, head.row + 1);
			} else if (this.direction === 'left') {
				newHead = new Block(head.col - 1, head.row);
			} else if (this.direction === 'up') {
				newHead = new Block(head.col, head.row - 1);
			}

			if (this.checkCollisition(newHead)) {
				stop = true;
				return;
			}

			this.segments.unshift(newHead);

			if (newHead.equal(apple.position)) {
				score++;
				apple.move();
			} else {
				this.segments.pop();
			}
		}

		Snake.prototype.checkCollisition = function(head) {
			let wallCollisition = false;
			let selfCollisition = false;

			if (head.col === 0 || head.row === 0 || head.col === blockNum - 1 || head.row === blockNum - 1) {
				wallCollisition = true;
			}

			for (let i = 0; i < this.segments.length; i++) {
				if (head.equal(this.segments[i])) {
					selfCollisition = true;
				}
			}

			return wallCollisition || selfCollisition;
		}

		Snake.prototype.setDirection = function(newDirection) {
			if (this.direction === 'up' && newDirection === 'down') {
				return;
			} else if (this.direction === 'right' && newDirection === 'left') {
				return;
			} else if (this.direction === 'down' && newDirection === 'up') {
				return;
			} else if (this.direction === 'left' && newDirection === 'right') {
				return;
			}

			this.nextDirection = newDirection;
		}

		let Apple = function() {
			this.position = new Block(5, 5);
		}

		Apple.prototype.draw = function() {
			this.position.drawCircle('red', '#bd0000');
		}

		Apple.prototype.move = function() {
			let randomCol = Math.floor(Math.random() * (blockNum - 2) + 1);
			let randomRow = Math.floor(Math.random() * (blockNum - 2) + 1);

			this.position = new Block(randomCol, randomRow);

			for (let i = 0; i < snake.segments.length; i++) {
				if (this.position.equal(snake.segments[i])) {
					this.move();
					break;
				}
			}
		}


		let snake = new Snake();
		let apple = new Apple();

		let timerId = setTimeout(function animation() {
			ctx.clearRect(0, 0, width, height);
			drawField();
			snake.move();
			snake.draw();
			apple.draw();
			drawScore();
			if (!stop) {
				timerId = setTimeout(animation, setSpeed());
			}
		}, speed);

		window.addEventListener('keydown', function(event) {
			let newDirection = directions[event.keyCode];
			if (newDirection !== undefined) snake.setDirection(newDirection);
		});

		button.addEventListener('click', function () {
			
		});
	</script>
</body>

</html>