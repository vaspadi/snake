<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width">
	<title>Snake 2</title>
</head>

<body>
	<div class="game">
		<canvas id="canvas" width="700" height="700"></canvas>
		<div id="score"></div>
		<button id="test-button">Click!</button>
	</div>

	<script>
		const canvas = document.getElementById('canvas');
		const score = document.getElementById('score');
		const button = document.getElementById('test-button');
		const ctx = canvas.getContext('2d');
		const width = canvas.width;
		const height = canvas.height;
		const blockNum = 22;
		const blockWidth = width / blockNum;
		const blockHeight = height / blockNum;
		const directions = {
			37: 'left',
			38: 'up',
			39: 'right',
			40: 'down'
		}
		let myScore = 0;

		function drawBorder() {
			ctx.fillStyle = '#ccc';
			ctx.fillRect(0, 0, width, blockHeight); // up
			ctx.fillRect(width - blockWidth, 0, blockWidth, height); // right
			ctx.fillRect(0, height - blockHeight, width, blockHeight); // down
			ctx.fillRect(0, 0, blockWidth, height); // left
		}

		let Block = function(col, row) {
			this.col = col;
			this.row = row;
		}

		Block.prototype.drawSquare = function(color) {
			let x = this.col * blockWidth;
			let y = this.row * blockHeight;
			
			ctx.fillStyle = color;
			ctx.fillRect(x, y, blockWidth, blockHeight);
		}

		Block.prototype.drawCircle = function(color) {
			let centerX = this.col * blockWidth + blockWidth / 2;
			let centerY = this.row * blockHeight + blockHeight / 2;

			ctx.fillStyle = color;
			ctx.beginPath();
			ctx.arc(centerX, centerY, blockWidth / 2, 0, Math.PI * 2, false);
			ctx.fill();
		}

		Block.prototype.equal = function(otherBlock) {
			return this.col === otherBlock.col && this.row === otherBlock.row;
		}

		let Snake = function() {
			this.segments = [
				new Block(3, 1),
				new Block(2, 1),
				new Block(1, 1)
			];
			this.direction = 'right';
			this.nextDirection = 'right';
		}

		Snake.prototype.draw = function() {
			for (let i = 0; i < this.segments.length; i++) {
				this.segments[i].drawSquare('blue');
			}
		}

		Snake.prototype.move = function() {
			let head = this.segments[0];
			let newHead;
			this.direction = this.nextDirection;

			if (this.direction === 'right') {
				newHead = new Block(head.col + 1, head.row);
			} else if (this.direction === 'down') {
				newHead = new Block(head.col, head.row + 1);
			} else if (this.direction === 'left') {
				newHead = new Block(head.col - 1, head.row);
			} else if (this.direction === 'up') {
				newHead = new Block(head.col, head.row - 1);
			}

			if (this.checkCollisition(newHead)) {
				return;
			}

			this.segments.unshift(newHead);

			if (newHead.equal(apple.position)) {
				myScore++;
				apple.move();
			} else {
				this.segments.pop();
			}
		}

		Snake.prototype.checkCollisition = function(head) {
			let wallCollisition = false;
			let selfCollisition = false;

			if (head.col === 0 || head.row === 0 || head.col === blockNum - 1 || head.row === blockNum - 1) {
				wallCollisition = true;
			}

			for (let i = 0; i < this.segments.length; i++) {
				if (head.equal(this.segments[i])) {
					selfCollisition = true;
				}
			}

			return wallCollisition || selfCollisition;
		}

		Snake.prototype.setDirection = function(newDirection) {
			if (this.direction === 'up' && newDirection === 'down') {
				return;
			} else if (this.direction === 'right' && newDirection === 'left') {
				return;
			} else if (this.direction === 'down' && newDirection === 'up') {
				return;
			} else if (this.direction === 'left' && newDirection === 'right') {
				return;
			}

			this.nextDirection = newDirection;
		}

		let Apple = function() {
			this.position = new Block(10, 10);
		}

		Apple.prototype.draw = function() {
			this.position.drawCircle('red');
		}

		Apple.prototype.move = function() {
			let randomCol = Math.floor(Math.random() * (blockNum - 2) + 1);
			let randomRow = Math.floor(Math.random() * (blockNum - 2) + 1);
			this.position = new Block(randomCol, randomRow);
		}


		let snake = new Snake();
		let apple = new Apple();

		let intervalId = setInterval(function() {
			ctx.clearRect(0, 0, width, height);
			snake.move();
			snake.draw();
			apple.draw();
			drawBorder();
		}, 500);

		window.addEventListener('keydown', function(event) {
			let newDirection = directions[event.keyCode];
			if (newDirection !== undefined) snake.setDirection(newDirection);
		});

		button.addEventListener('click', function () {
			
		});
	</script>
</body>

</html>